This is the core code 